{% extends 'base.html' %}
{% block title %}AI 여행 상담{% endblock %}

{% block extra_css %}
{{ block.super }}
<style>
    .schedule-form-container {
        max-width: 900px;
        margin: 40px auto;
        padding: 20px;
        background: #ffffff;
        border-radius: 15px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
    }

    .page-title {
        color: #007acc;
        text-align: center;
        margin-bottom: 30px;
        font-size: 2.5rem;
        font-weight: bold;
    }

    .form-section {
        margin-bottom: 35px;
    }

    .section-title {
        color: #007acc;
        font-size: 1.4rem;
        margin: 30px 0 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid #007acc;
        font-weight: 600;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-label {
        display: block;
        color: #333;
        margin-bottom: 8px;
        font-weight: 500;
    }

    .form-input,
    .form-select,
    textarea {
        width: 100%;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 1rem;
        transition: border 0.3s;
    }

    .form-input:focus,
    .form-select:focus,
    textarea:focus {
        border-color: #007acc;
        outline: none;
    }

    .checkbox-group,
    .radio-group {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
    }

    .checkbox-option,
    .radio-option {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 0.95rem;
    }

    .form-actions {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-top: 40px;
    }

    .submit-button,
    .cancel-button {
        padding: 14px 30px;
        font-size: 1rem;
        border: none;
        border-radius: 30px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .submit-button {
        background: #007acc;
        color: white;
    }

    .submit-button:hover {
        background: #005f99;
    }

    .cancel-button {
        background: #888;
        color: white;
        text-decoration: none;
    }

    .cancel-button:hover {
        background: #666;
    }

    .error-message {
        color: #dc3545;
        font-size: 0.9rem;
        margin-top: 5px;
    }

    .checkbox-group ul,
    .radio-group ul {
        list-style: none;
        padding: 0;
        margin: 0;
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
    }

    .checkbox-group li,
    .radio-group li {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 0.95rem;
    }

    .checkbox-group input[type="checkbox"],
    .radio-group input[type="radio"] {
        margin-right: 6px;
    }

    .checkbox-group label,
    .radio-group label {
        cursor: pointer;
    }

    .info-message {
        color: #6c757d;
        font-size: 0.9rem;
        margin-top: 5px;
    }

    .participant-formset {
        margin-bottom: 20px;
    }
    
    .participant-form {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        transition: opacity 0.3s ease;
    }
    
    .participant-form.to-delete {
        opacity: 0.5;
        pointer-events: none;
    }
    
    .participant-form-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid #dee2e6;
    }
    
    .participant-group-title {
        font-size: 1.1rem;
        color: #495057;
        margin: 0;
    }
    
    .participant-form-content {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
    }
    
    .radio-group {
        display: flex;
        gap: 15px;
    }
    
    .radio-group input[type="radio"] {
        margin-right: 5px;
    }
    
    .delete-form {
        display: flex;
        align-items: center;
    }
    
    .delete-label {
        color: #dc3545;
        background: none;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 5px;
        padding: 5px 10px;
        border-radius: 5px;
        transition: all 0.3s;
        font-size: 0.9rem;
    }
    
    .delete-label:hover {
        background-color: #dc3545;
        color: white;
    }
    
    .delete-form input[type="checkbox"] {
        display: none;
    }
    
    .age-range-group select {
        max-width: 200px;
    }
    
    .participant-actions {
        display: flex;
        justify-content: center;
    }
    
    .add-participant-button {
        display: flex;
        align-items: center;
        gap: 8px;
        background: #28a745;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 20px;
        font-size: 1rem;
        cursor: pointer;
        transition: background-color 0.3s;
    }
    
    .add-participant-button:hover {
        background: #218838;
    }
    
    .mb-3 {
        margin-bottom: 1rem;
    }
    
    .mt-3 {
        margin-top: 1rem;
    }
    
    .family-check {
        display: flex;
        align-items: center;
        margin: 0 15px;
    }
    
    .family-check label {
        display: flex;
        align-items: center;
        gap: 5px;
        cursor: pointer;
        padding: 5px 10px;
        border-radius: 15px;
        transition: all 0.3s;
        color: #6c757d;
    }
    
    .family-check input[type="checkbox"] {
        margin-right: 5px;
    }
    
    .family-check input[type="checkbox"]:checked + i {
        color: #28a745;
    }
    
    .family-check label:hover {
        background-color: #e9ecef;
    }
    
    .family-check i {
        transition: color 0.3s;
    }
</style>
{% endblock %}

{% block content %}
<div class="schedule-form-container">
    <h1 class="page-title">AI 여행 상담</h1>

    <form method="post" id="scheduleForm">
        {% csrf_token %}
        {{ participant_formset.management_form }}

        <div class="form-section">
            <h2 class="section-title">기본 정보</h2>
            {% if form.non_field_errors %}
            <div class="error-message">
                {{ form.non_field_errors }}
            </div>
            {% endif %}
            <div class="form-group">
                <label class="form-label" for="{{ form.title.id_for_label }}">여행 주제</label>
                {{ form.title }}
                {% if form.title.errors %}
                <div class="error-message">{{ form.title.errors }}</div>
                {% endif %}
            </div>
            <div class="form-group">
                <label class="form-label" for="{{ form.destination.id_for_label }}">여행지</label>
                {{ form.destination }}
            </div>
            <div class="form-group">
                <label class="form-label" for="{{ form.start_date.id_for_label }}">출발일</label>
                {{ form.start_date }}
            </div>
            <div class="form-group">
                <label class="form-label" for="{{ form.end_date.id_for_label }}">도착일</label>
                {{ form.end_date }}
            </div>
            <div class="form-group">
                <label class="form-label" for="{{ form.budget.id_for_label }}">예산</label>
                {{ form.budget }}
            </div>
            <div class="info-message">
                * 여행 인원은 일정 생성 후 상세 페이지에서 추가할 수 있습니다.
            </div>
        </div>

        <div class="form-section">
            <h2 class="section-title">여행 스타일</h2>
            <div class="checkbox-group">
                {{ form.travel_style }}
            </div>
        </div>

        <div class="form-section">
            <h2 class="section-title">여행 시 중요 요소</h2>
            <div class="checkbox-group">
                {{ form.important_factors }}
            </div>
        </div>

        <div class="form-section">
            <h2 class="section-title">여행 계획 요소</h2>
            <div class="form-group">
                <label class="form-label">출발 지역</label>
                {{ form.departure_region }}
            </div>
            <div class="form-group">
                <label class="form-label">여행 목적</label>
                {{ form.purpose }}
            </div>
            <div class="form-group">
                <label class="form-label">반려동물 동반 여부</label>
                {{ form.pet_friendly }}
            </div>
            <div class="form-group">
                <label class="form-label">선호 교통수단</label>
                {{ form.transport }}
            </div>
        </div>

        <div class="form-section">
            <h2 class="section-title">숙소 정보</h2>
            <div class="form-group">
                <label class="form-label">숙소 요청사항</label>
                {{ form.lodging_request }}
                <div class="info-message">
                    * 가족 여행인 경우, 가족 구성원 수를 입력해주세요.
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">기타 요청사항</label>
                {{ form.notes }}
            </div>
        </div>

        <div class="form-section">
            <h2 class="section-title">참여자 정보</h2>
            <div class="info-message mb-3">
                * 참여자 그룹별로 입력해주세요. (예: 성인 2명, 아동 1명)
            </div>
            {% if participant_formset.non_form_errors %}
            <div class="error-message">
                {{ participant_formset.non_form_errors }}
            </div>
            {% endif %}
            <div class="participant-formset">
                {% for form in participant_formset %}
                <div class="participant-form{% if form.DELETE.value %} to-delete{% endif %}">
                    <div class="participant-form-header">
                        <h3 class="participant-group-title">참여자 그룹 #{{ forloop.counter }}</h3>
                        <div class="form-check family-check">
                            <label class="form-check-label" for="{{ form.is_family.id_for_label }}">
                                {{ form.is_family }}
                                <i class="fas fa-users"></i> 가족
                            </label>
                        </div>
                        <div class="form-check elderly-check">
                            <label class="form-check-label" for="{{ form.is_elderly.id_for_label }}">
                                {{ form.is_elderly }}
                                <i class="fas fa-user-clock"></i> 노인
                            </label>
                        </div>
                        <div class="delete-form">
                            <button type="button" class="delete-label">
                                <i class="fas fa-times"></i> 삭제
                            </button>
                        </div>
                    </div>
                    <div class="participant-form-content">
                        {% for field in form.visible_fields %}
                        {% if field.name != 'DELETE' and field.name != 'is_family' and field.name != 'is_elderly' %}
                        <div class="form-group">
                            <label class="form-label">{{ field.label }}</label>
                            {{ field }}
                            {% if field.errors %}
                            <div class="error-message">{{ field.errors }}</div>
                            {% endif %}
                        </div>
                        {% endif %}
                        {% endfor %}
                        {% for hidden in form.hidden_fields %}
                        {{ hidden }}
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
            <div class="participant-actions mt-3">
                <button type="button" class="add-participant-button">
                    <i class="fas fa-plus"></i> 참여자 그룹 추가
                </button>
            </div>
        </div>

        <div class="form-actions">
            <button type="submit" class="submit-button">다음 단계로</button>
            <a href="{% url 'travel_input:schedule_list' %}" class="cancel-button">취소</a>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('JS 로드됨');
    const addButton = document.querySelector('.add-participant-button');
    const formset = document.querySelector('.participant-formset');
    const totalForms = document.querySelector('#id_participants-TOTAL_FORMS');
    const form = document.querySelector('#scheduleForm');
    
    function updateFormIndex(element, index) {
        ['name', 'id', 'for'].forEach(attr => {
            if (element[attr]) {
                element[attr] = element[attr].replace(/-\d+-/, `-${index}-`);
            }
        });
    }
    
    function updateAgeRangeOptions(ageTypeRadios, ageRangeSelect) {
        const ageRangesByType = {
            '영유아': ['0-2세', '3-7세'],
            '아동': ['3-7세', '8-13세'],
            '청소년': ['14-19세'],
            '성인': ['20대', '30대', '40대', '50대', '60대', '70대 이상']
        };
        
        ageTypeRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                const selectedType = this.value;
                const validRanges = ageRangesByType[selectedType] || [];
                
                while (ageRangeSelect.firstChild) {
                    ageRangeSelect.removeChild(ageRangeSelect.firstChild);
                }
                
                validRanges.forEach(range => {
                    const option = document.createElement('option');
                    option.value = range;
                    option.textContent = range;
                    ageRangeSelect.appendChild(option);
                });
                
                if (ageRangeSelect.options.length > 0) {
                    ageRangeSelect.selectedIndex = 0;
                }
            });
        });
    }
    
    function validateForm() {
        const activeForms = formset.querySelectorAll('.participant-form:not(.to-delete)');
        if (activeForms.length === 0) {
            alert('최소 한 명 이상의 참여자 정보를 입력해주세요.');
            return false;
        }
        
        let isValid = true;
        activeForms.forEach(form => {
            const numPeople = form.querySelector('input[name$="-num_people"]');
            const gender = form.querySelector('input[name$="-gender"]:checked');
            const ageType = form.querySelector('input[name$="-age_type"]:checked');
            const ageRange = form.querySelector('select[name$="-age_range"]');
            
            if (!numPeople || !numPeople.value || parseInt(numPeople.value) < 1) {
                alert('인원수를 입력해주세요.');
                isValid = false;
                return;
            }
            
            if (!gender) {
                alert('성별을 선택해주세요.');
                isValid = false;
                return;
            }
            
            if (!ageType) {
                alert('구분을 선택해주세요.');
                isValid = false;
                return;
            }
            
            if (!ageRange || !ageRange.value) {
                alert('연령대를 선택해주세요.');
                isValid = false;
                return;
            }
        });
        
        return isValid;
    }
    
    if (addButton && formset && totalForms) {
        const emptyForm = formset.querySelector('.participant-form').cloneNode(true);
        
        // 초기 폼에 대해 연령대 필드 업데이트 설정
        formset.querySelectorAll('.participant-form').forEach(form => {
            const ageTypeRadios = form.querySelectorAll('input[name$="-age_type"]');
            const ageRangeSelect = form.querySelector('select[name$="-age_range"]');
            if (ageTypeRadios && ageRangeSelect) {
                updateAgeRangeOptions(ageTypeRadios, ageRangeSelect);
            }
        });
        
        addButton.addEventListener('click', function() {
            const formCount = formset.querySelectorAll('.participant-form').length;
            const newForm = emptyForm.cloneNode(true);
            
            newForm.classList.remove('to-delete');
            newForm.querySelectorAll('input, select, label').forEach(element => {
                updateFormIndex(element, formCount);
            });
            
            const titleElement = newForm.querySelector('.participant-group-title');
            if (titleElement) {
                titleElement.textContent = `참여자 그룹 #${formCount + 1}`;
            }
            
            newForm.querySelectorAll('input[type="number"]').forEach(input => {
                input.value = '1';
            });
            newForm.querySelectorAll('input[type="radio"]').forEach(radio => {
                radio.checked = false;
            });
            newForm.querySelectorAll('select').forEach(select => {
                select.selectedIndex = 0;
            });
            newForm.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
            
            const ageTypeRadios = newForm.querySelectorAll('input[name$="-age_type"]');
            const ageRangeSelect = newForm.querySelector('select[name$="-age_range"]');
            if (ageTypeRadios && ageRangeSelect) {
                updateAgeRangeOptions(ageTypeRadios, ageRangeSelect);
            }
            
            formset.appendChild(newForm);
            totalForms.value = formCount + 1;
        });
        
        form.addEventListener('submit', function(e) {
            if (!validateForm()) {
                e.preventDefault();
            }
        });

        formset.addEventListener('click', function(e) {
            const deleteBtn = e.target.closest('.delete-label');
            if (deleteBtn) {
                e.preventDefault();
                const form = deleteBtn.closest('.participant-form');
                if (form) {
                    const deleteInput = form.querySelector('input[name$="-DELETE"]');
                    if (deleteInput) {
                        deleteInput.checked = true;
                        form.classList.add('to-delete');
                        form.style.display = 'none';
                    }
                }
            }
        });
    }
});
</script>
{% endblock %}